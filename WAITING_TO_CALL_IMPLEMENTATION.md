# Waiting to Call Section Implementation

## Overview
A new "Waiting to Call" section has been created that displays leads from the `waiting_to_call` table across all businesses the user has access to, based on their permissions (super administrator or profile_business relationships).

## Key Features
- **Cross-business viewing**: Shows leads from ALL businesses the user has permission to access
- **Permission-based filtering**:
  - Super admins (role = 0) see all waiting_to_call leads
  - Regular users see only leads from businesses in their profile_businesses assignments
- **Business name column**: Displays which business each lead belongs to
- **Priority system**: Leads can be marked as Low (1), Medium (2), or High (3) priority
- **Notes support**: Optional notes can be added for each waiting_to_call entry

## Files Created/Modified

### 1. Database Migration
**File**: `migrations/create_waiting_to_call_table.sql`
- Creates the `waiting_to_call` table with proper schema
- Sets up foreign key relationships to `leads` and `profiles` tables
- Implements Row Level Security (RLS) policies for permission-based access
- Creates indexes for optimized queries

**To apply the migration:**
```bash
# Using Supabase CLI
supabase db push

# Or manually execute the SQL file in your Supabase dashboard
```

### 2. API Endpoint
**File**: `src/app/api/leads/waiting-to-call/route.ts`
- GET endpoint that fetches waiting_to_call leads with permissions filtering
- Automatically determines accessible businesses based on user role
- Joins with leads, business_clients, clients, and call_windows tables
- Returns enriched data including business name

**Endpoint**: `GET /api/leads/waiting-to-call`

### 3. TypeScript Types
**File**: `src/types/leads.ts`
- Added `WaitingToCall` interface
- Added `WaitingToCallLead` interface (extends LeadWithClient)
- Includes business_name field for cross-business display

### 4. Components

#### WaitingToCallTable Component
**File**: `src/components/features/leads/WaitingToCallTable.tsx`
- Specialized table component for waiting_to_call leads
- Displays additional columns: Business Name, Priority
- Shows notes inline if available
- Handles navigation with business context
- Exported from `src/components/features/leads/index.ts`

#### WaitingToCallClient Component
**File**: `src/components/WaitingToCallClient.tsx`
- Client component that fetches and displays waiting_to_call data
- Handles authentication and loading states
- Uses WaitingToCallTable for display

### 5. Page Route
**File**: `src/app/[business_id]/[permalink]/waiting-to-call/page.tsx`
- Creates the route at: `/{business_id}/{permalink}/waiting-to-call`
- Uses cached authentication from AuthDataProvider
- Renders WaitingToCallClient component

### 6. Navigation
**File**: `src/lib/permalink-utils.ts`
- Added "Waiting to Call" to NAVIGATION_SECTIONS
- Positioned between "Follow Up" and "Bookings" in the navigation menu
- Automatically appears in the header for all users

## Database Schema

### waiting_to_call Table
```sql
CREATE TABLE public.waiting_to_call (
    waiting_id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    lead_id integer NOT NULL UNIQUE,
    business_id smallint NOT NULL,
    account_id text NOT NULL,
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now(),
    notes text,
    priority smallint DEFAULT 1 CHECK (priority >= 1 AND priority <= 3),
    scheduled_for timestamptz,
    added_by uuid,

    CONSTRAINT fk_waiting_to_call_lead FOREIGN KEY (lead_id) REFERENCES public.leads(lead_id) ON DELETE CASCADE,
    CONSTRAINT fk_waiting_to_call_profile FOREIGN KEY (added_by) REFERENCES public.profiles(id) ON DELETE SET NULL
);
```

### Indexes
- `idx_waiting_to_call_business_id` - Fast lookups by business
- `idx_waiting_to_call_created_at` - Sort by creation date
- `idx_waiting_to_call_scheduled_for` - Filter by scheduled time
- `idx_waiting_to_call_priority` - Sort by priority

### RLS Policies
Four policies control access:
1. **SELECT**: Users see leads from accessible businesses
2. **INSERT**: Users can add leads for accessible businesses
3. **UPDATE**: Users can modify leads for accessible businesses
4. **DELETE**: Users can remove leads for accessible businesses

All policies check:
- Super admin status (role = 0) → access to all
- OR profile_businesses relationship → access to assigned businesses

## How It Works

### Permission Flow
```
User Authentication
    ↓
Determine User Role
    ↓
If Super Admin (role = 0)
    → Fetch all businesses with dashboard=true
    → Query waiting_to_call for those businesses

If Regular User
    → Fetch assigned businesses from profile_businesses
    → Query waiting_to_call for those businesses

    ↓
Join with:
    - leads (get lead details + call_windows)
    - business_clients (get company_name)
    - clients (get property info)
    ↓
Return enriched data with business_name
```

### Navigation
Users can access the section via:
1. **Header Navigation**: "Waiting to Call" menu item
2. **Direct URL**: `/{business_id}/{permalink}/waiting-to-call`

### Display
The table shows:
- **Lead Name** - with call history icons and working hours indicator
- **Business** - Company name from business_clients
- **Source** - Facebook, Google, Website, Referral with color coding
- **Priority** - Low/Medium/High badge
- **Date Added** - When added to waiting list
- **Timer** - Call window circular timer

## Next Steps

### 1. Apply Database Migration
Run the SQL migration to create the table:
```bash
# Apply via Supabase CLI
supabase db push

# Or execute migrations/create_waiting_to_call_table.sql in Supabase dashboard
```

### 2. Test Permissions
Verify that:
- Super admins see all waiting_to_call leads
- Regular users see only leads from their assigned businesses
- RLS policies properly restrict access

### 3. Add Leads to Waiting List (Future Enhancement)
You'll need to create functionality to add leads to the waiting_to_call table:
- Add "Add to Waiting List" button in lead details
- Create POST endpoint: `/api/leads/waiting-to-call` (not yet implemented)
- Include form for priority, notes, and scheduled_for

### 4. Remove from Waiting List (Future Enhancement)
Create DELETE functionality:
- Add "Remove from List" button in WaitingToCallTable
- Create DELETE endpoint handler (not yet implemented)

### 5. Update Waiting List Items (Future Enhancement)
Create UPDATE functionality:
- Add inline editing for notes and priority
- Create PATCH endpoint: `/api/leads/waiting-to-call/{waiting_id}` (not yet implemented)

## API Response Format

```typescript
{
  "data": [
    {
      // All standard lead fields
      "lead_id": "123",
      "first_name": "John",
      "last_name": "Doe",
      // ... other lead fields

      // Waiting to call specific fields
      "waiting_id": 1,
      "waiting_notes": "Customer requested callback",
      "waiting_priority": 3,  // 1=Low, 2=Medium, 3=High
      "waiting_scheduled_for": "2025-10-22T10:00:00Z",
      "waiting_added_by": "uuid-here",
      "waiting_created_at": "2025-10-21T15:30:00Z",

      // Business context
      "business_name": "Houston Custom Renovations",
      "business_id": "1",

      // Related data
      "client": { /* property info */ },
      "callWindows": [ /* call history */ ]
    }
  ],
  "success": true
}
```

## Testing Checklist

- [ ] Apply database migration successfully
- [ ] Navigate to Waiting to Call section
- [ ] Verify empty state displays when no leads
- [ ] Add test data to waiting_to_call table
- [ ] Verify leads display with business name
- [ ] Test as super admin - should see all leads
- [ ] Test as regular user - should see only assigned businesses
- [ ] Verify priority badges display correctly
- [ ] Verify notes display inline
- [ ] Test navigation to lead details
- [ ] Test context menu "Open in New Tab"
- [ ] Verify call window icons display
- [ ] Verify responsive design on mobile

## Architecture Notes

### Why Cross-Business Display?
Unlike other sections (New Leads, Follow Up, Bookings) that filter by current business_id, the Waiting to Call section shows leads across ALL accessible businesses. This design choice allows users to:
- See their entire waiting list in one place
- Manage callbacks across multiple businesses efficiently
- Quickly identify which business each lead belongs to

### Permission Design
The permission system uses the same logic as existing sections:
- **Database Level**: RLS policies enforce access control
- **API Level**: Backend validates user permissions before querying
- **Client Level**: No business_id filtering - shows all accessible leads

### Performance Considerations
- Indexed queries on business_id and priority for fast filtering
- Cached authentication reduces redundant database calls
- Memoized components prevent unnecessary re-renders
- Limit results if needed (currently unlimited - may want to add pagination)

## Troubleshooting

### "User not authenticated" error
- Ensure user is logged in
- Check authentication token validity
- Verify AuthDataProvider is wrapping the component

### No leads showing
- Verify waiting_to_call table has data
- Check user permissions (profile_businesses entries)
- Verify RLS policies are enabled
- Check browser console for API errors

### Business name not displaying
- Verify business_clients join in API query
- Check company_name field exists in business_clients table
- Verify business_id foreign key relationships

### Permission errors
- Verify user role in profiles table
- Check profile_businesses entries for regular users
- Ensure RLS policies are correctly defined
- Test with different user roles

## Future Enhancements

1. **Add to Waiting List**: Create UI to add leads from lead details page
2. **Bulk Actions**: Select multiple leads and update priority/delete
3. **Scheduled Callbacks**: Calendar integration for scheduled_for field
4. **Notifications**: Alert users when scheduled callback time approaches
5. **Search/Filter**: Filter by business, priority, or date range
6. **Sorting**: Sort by priority, date, or business name
7. **Pagination**: Add pagination for large datasets
8. **Analytics**: Track callback completion rates and timing

## Related Files Reference

- Main entry point: `src/app/[business_id]/[permalink]/waiting-to-call/page.tsx`
- API endpoint: `src/app/api/leads/waiting-to-call/route.ts`
- Client component: `src/components/WaitingToCallClient.tsx`
- Table component: `src/components/features/leads/WaitingToCallTable.tsx`
- Types: `src/types/leads.ts`
- Navigation: `src/lib/permalink-utils.ts`
- Migration: `migrations/create_waiting_to_call_table.sql`
